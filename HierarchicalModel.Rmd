---
title: "Simple Models"
author: "Daniel Hopkins & Rob Verbeek"
date: "12/1/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rstan)
library(ggplot2)
library(corrplot)
library(rstanarm)
library("bayesplot")
theme_set(bayesplot::theme_default(base_family = "sans"))
SEED = 1234 
options(mc.cores = parallel::detectCores())
```

## Reading in the ESS Data

```{r selecting data rows and variables}
# N = 1000 # Number of sample points

set.seed(1234)

ESSData <- read.csv(file="data/filtered_data2.csv", header=TRUE, sep=",")
M = length(ESSData$lrscale)



country = ESSData$cntry
age = 2016 - ESSData$yrbrn
age = age/max(age)
drops = c("cntry","yrbrn")
ESSData = ESSData[,!(names(ESSData) %in% drops)] / 10
ESSData = data.frame(age,ESSData)

SAMPLESIZE = 5000

sample_rows = sample(seq(1,M),SAMPLESIZE)

test_rows = sample(seq(1,SAMPLESIZE),1000)

sample_data = data.frame(ESSData[sample_rows,])

training_data = data.frame(sample_data[-test_rows,])

test_data = data.frame(sample_data[test_rows,])


```

```{r correlation matrix}
c = cor(data.frame(sample_data))
lrscale_cor = c["lrscale",]
best_variables = lrscale_cor[order(abs(lrscale_cor),decreasing=TRUE)][1:21]
best_columns = order(abs(lrscale_cor),decreasing=TRUE)[1:21]
sample_data_best_vars = sample_data[best_columns]
sample_data_best_vars = cbind(country[sample_rows], sample_data_best_vars)
colnames(sample_data_best_vars)[1] <- "country"
best_variables
```
## Pooled model
The pooled model considers all data the same, thus not take into account the country each datapoint is from. It fits one linear model to predict the left-right scale, based on all input variables. 


## Partially pooled
The previous model is pooled, assuming there is no differences between countries. The partially pooled model allows for differentation between countries. Each country will have it's own intecept and slope per variable, but these parameters are fitted to an overall distribution. This still allows the model to generalize over the entire dataset, while being able to fit a more narrow distribution on each country individually.

```{r}
fit_hier_1 <- stan_lmer(lrscale ~ 1 + gincdif + impcntr + (1 + gincdif + impcntr | country), data=sample_data_best_vars)
print(fit_hier_1, digits=2)
```

```{r}
fit_hier_2 <- stan_lmer(lrscale ~ 1 + gincdif + impcntr + dfincac + (1 + gincdif + impcntr + dfincac | country), data=sample_data_best_vars)
print(fit_hier_2, digits=2)
```


```